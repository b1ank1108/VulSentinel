---
cve_id: CVE-2023-38646
template_path: nuclei-templates/http/cves/2023/CVE-2023-38646.yaml
affected_product: Metabase
severity: critical
authentication: none
external_callback: false
affected_versions: open source before 0.46.6.1 and Enterprise before 1.46.6.1 (other fixed versions: 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, 1.43.7.2)
preconditions: []
poc_classification: rce
---

## Vulnerability
Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1 allow unauthenticated attackers to execute arbitrary commands on the server at the server's privilege level via the database setup validation endpoint. CVSS v3.1: 9.8 (AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H). Successful exploitation results in arbitrary code execution.

## PoC / Detection
Classification: rce

The template detects the flaw with a two-request sequence that triggers the vulnerable code path without authentication:

- GET /api/session/properties extracts the publicly exposed `setup-token`.
- POST /api/setup/validate submits a JSON payload setting a Postgres engine but using H2 driver details with `subname: "mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM './plugins/vertica.metabase-driver.jar'//\\;"` to force script execution.

Matchers confirm exploitation attempt via presence of "Syntax error in SQL statement" or "NoSuchFileException" in the response body combined with HTTP 400 status on the second request.

## References
- https://www.metabase.com/blog/security-advisory
- https://github.com/metabase/metabase/releases/tag/v0.46.6.1
- https://mp.weixin.qq.com/s/ATFwFl-D8k9QfQfzKjZFDg
- https://news.ycombinator.com/item?id=36812256
- https://blog.assetnote.io/2023/07/22/pre-auth-rce-metabase/
- https://gist.github.com/testanull/a7beb2777bbf550f3cf533d2794477fe
