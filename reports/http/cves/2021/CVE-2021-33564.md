---
cve_id: CVE-2021-33564
template_path: nuclei-templates/http/cves/2021/CVE-2021-33564.yaml
affected_product: Ruby Dragonfly
severity: critical
authentication: none
external_callback: false
affected_versions: <1.4.0
preconditions: verify_url option disabled
poc_classification: rce
---

## Vulnerability
Ruby Dragonfly before 1.4.0 contains an argument injection vulnerability that allows remote attackers to read and write to arbitrary files via a crafted URL when the verify_url option is disabled. This may lead to code execution. The problem occurs because the generate and process features mishandle use of the ImageMagick convert utility. Successful exploitation could allow an attacker to execute arbitrary code on the affected system.

## PoC / Detection
Classification: rce

The template issues GET requests to `/system/images/W1siZyIsICJjb252ZXJ0IiwgIi1zaXplIDF4MSAtZGVwdGggOCBncmF5Oi9ldGMvcGFzc3dkIiwgIm91dCJdXQ==` and the equivalent `/system/refinery/images/` path (base64 payload injecting ImageMagick `convert` arguments to read `/etc/passwd` as 1x1 grayscale). It verifies via HTTP 200 status and regex match `root:.*:0:0:` in the response body.

## References
- https://zxsecurity.co.nz/research/argunment-injection-ruby-dragonfly/
- https://github.com/markevans/dragonfly/compare/v1.3.0...v1.4.0
- https://github.com/markevans/dragonfly/commit/25399297bb457f7fcf8e3f91e85945b255b111b5
- https://github.com/mlr0p/CVE-2021-33564
- https://nvd.nist.gov/vuln/detail/CVE-2021-33564
