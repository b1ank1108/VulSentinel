---
cve_id: CVE-2024-8698
template_path: nuclei-templates/http/cves/2024/CVE-2024-8698.yaml
affected_product: Keycloak
severity: high
authentication: required
external_callback: false
affected_versions: unknown
preconditions: SAML broker configured in realm; valid AUTH_SESSION_ID_LEGACY cookie and RELAYSTATE from prior SAML flow
poc_classification: auth-bypass
---

## Vulnerability
Keycloak contains a signature validation flaw in the SAML Core Package (XMLSignatureUtil class). Validation incorrectly uses the position of the `<ds:Signature>` element in the XML document instead of the Reference element to decide whether the signature covers the full document or only specific assertions. This enables attackers to craft malicious SAML responses that bypass validation.

Impact: privilege escalation, user impersonation, unauthorized access to protected resources.  
CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:C/C:H/I:L/A:L (7.7) | CWE-347

## PoC / Detection
Classification: auth-bypass

The template first runs Python code (lxml/etree) on a legitimate base64-encoded SAMLResponse obtained via environment variable: removes the root-level and assertion signatures, modifies the NameID and all AttributeValue elements to impersonate a target user (default: admin@example.com), adjusts the Assertion ID, re-inserts the modified assertion, then base64-encodes and URL-encodes the result. It issues a POST request to `/realms/master/broker/saml/endpoint` supplying the tampered `SAMLResponse`, the original `RELAYSTATE`, and the `AUTH_SESSION_ID_LEGACY` cookie. Success is confirmed by a 302 redirect containing both `KEYCLOAK_IDENTITY` and `KEYCLOAK_SESSION` cookies.

## References
- https://nvd.nist.gov/vuln/detail/CVE-2024-8698
- https://access.redhat.com/errata/RHSA-2024:6878
- https://access.redhat.com/errata/RHSA-2024:6879
- https://access.redhat.com/errata/RHSA-2024:6880
- https://access.redhat.com/errata/RHSA-2024:6882
