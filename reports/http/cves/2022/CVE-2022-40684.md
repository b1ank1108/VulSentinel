---
cve_id: CVE-2022-40684
template_path: nuclei-templates/http/cves/2022/CVE-2022-40684.yaml
affected_product: Fortinet FortiOS, FortiProxy, FortiSwitchManager
severity: critical
authentication: none
external_callback: false
affected_versions: FortiOS 7.2.0-7.2.1, 7.0.0-7.0.6; FortiProxy 7.2.0, 7.0.0-7.0.6; FortiSwitchManager 7.2.0, 7.0.0
preconditions: []
poc_classification: auth-bypass
---

## Vulnerability

CVE-2022-40684 is a critical authentication bypass vulnerability affecting Fortinet products including FortiOS, FortiProxy, and FortiSwitchManager. The vulnerability exists due to improper authentication handling when processing specially crafted HTTP/HTTPS requests that use alternate paths or channels. By manipulating HTTP headers (specifically `Forwarded` and `X-Forwarded-Vdom` headers), an unauthenticated attacker can bypass authentication mechanisms and perform administrative operations on the device's management interface.

The vulnerability allows attackers to access the administrative API without valid credentials, enabling them to read sensitive configuration data, modify system settings, and execute unauthorized administrative operations. This represents a complete compromise of the authentication boundary, classified as CWE-287 (Improper Authentication). The CVSS score of 9.8 reflects the severity of allowing unauthenticated remote access to administrative functions with no user interaction required.

Affected versions include FortiOS 7.2.0 through 7.2.1 and 7.0.0 through 7.0.6, FortiProxy 7.2.0 and 7.0.0 through 7.0.6, and FortiSwitchManager 7.2.0 and 7.0.0.

## PoC / Detection

Classification: auth-bypass

The template detects this vulnerability through two sequential HTTP requests that exploit the authentication bypass:

1. **First request (GET)**: Attempts to retrieve the system admin configuration via `/api/v2/cmdb/system/admin` without authentication. The request includes crafted headers:
   - `User-Agent: Node.js`
   - `Forwarded: by="[127.0.0.1]:1337";for="[127.0.0.1]:1337";proto=http;host=`
   - `X-Forwarded-Vdom: root`
   
   Success is indicated by the response containing both "ENC XXXX" (encrypted password field) and "http_method" strings, confirming unauthorized access to admin configuration data.

2. **Second request (PUT)**: Attempts to modify the admin user configuration by updating the SSH public key via `/api/v2/cmdb/system/admin/admin`. Uses similar header manipulation with:
   - `User-Agent: Report Runner`
   - `Forwarded: for=[127.0.0.1]:8000;by=[127.0.0.1]:9000;`
   
   Success is indicated by the response containing "Invalid SSH public key" and "cli_error", confirming the system processed the modification request (rejecting only the invalid key format, not the unauthorized access itself).

The template uses `stop-at-first-match: true` and matches on either condition, demonstrating that successful exploitation of the authentication bypass can be verified through either read or write operations.

## References

- https://github.com/horizon3ai/CVE-2022-40684/blob/master/CVE-2022-40684.py
- https://securityonline.info/researchers-have-developed-cve-2022-40684-poc-exploit-code/
- https://socradar.io/what-do-you-need-to-know-about-fortinet-critical-authentication-bypass-vulnerability-cve-2022-40684/
- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-40684
- https://nvd.nist.gov/vuln/detail/CVE-2022-40684
